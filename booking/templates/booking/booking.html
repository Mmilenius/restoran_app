{% extends "includes/base.html" %}
{% load static %}

{% block content %}
<div class="container" style="max-width: 800px; margin: 2rem auto;">
    <div class="booking-header text-center mb-4">
        <h1>Бронювання столика</h1>
        <p class="text-muted">Забронюйте столик у нашому ресторані</p>
    </div>

    <div class="card">
        <div class="card-body">
            <form method="POST" id="booking-form">
                {% csrf_token %}
                
                <div class="row">
                    <div class="col-md-6">
                        <h4>Контактні дані</h4>
                        <div class="mb-3">
                            <label class="form-label">Повне ім'я *</label>
                            {{ form.full_name }}
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Номер телефону *</label>
                            {{ form.phone }}
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            {{ form.email }}
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <h4>Деталі бронювання</h4>
                        <div class="row">
                            <div class="col-6 mb-3">
                                <label class="form-label">Дата *</label>
                                {{ form.date }}
                            </div>
                            <div class="col-6 mb-3">
                                <label class="form-label">Час *</label>
                                {{ form.time }}
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-6 mb-3">
                                <label class="form-label">Гостей *</label>
                                {{ form.guests }}
                            </div>
                            <div class="col-6 mb-3">
                                <label class="form-label">Годин *</label>
                                {{ form.duration }}
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Зона *</label>
                            {{ form.zone }}
                        </div>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Додаткові побажання</label>
                    {{ form.notes }}
                </div>

                <div class="alert alert-info">
                    <strong>1.</strong> Ми підтвердимо ваше бронювання якомога швидше
                </div>

                <button type="submit" class="btn btn-primary btn-lg w-100">
                    Забронювати
                </button>
            </form>
        </div>
    </div>
</div>

<style>
.booking-header {
    background: linear-gradient(135deg, #FF5722, #FF7043);
    color: white;
    padding: 2rem;
    border-radius: 12px;
    margin-bottom: 2rem;
}

.form-label {
    font-weight: 600;
    margin-bottom: 0.5rem;
}

.form-control {
    border: 2px solid #e9ecef;
    border-radius: 8px;
    padding: 0.75rem;
}

.form-control:focus {
    border-color: #FF5722;
    box-shadow: 0 0 0 0.2rem rgba(255, 87, 34, 0.25);
}

.alert {
    border-radius: 8px;
    border: none;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('booking-form');
    const dateInput = document.querySelector('input[name="date"]');
    const timeInput = document.querySelector('input[name="time"]');
    const durationInput = document.querySelector('input[name="duration"]');
    const zoneSelect = document.querySelector('select[name="zone"]');

    // Встановлюємо мінімальну дату - сьогодні
    const today = new Date().toISOString().split('T')[0];
    dateInput.min = today;

    // Перевірка доступності часу при зміні
    function checkAvailability() {
        const date = dateInput.value;
        const time = timeInput.value;
        const duration = durationInput.value;
        const zone = zoneSelect.value;

        if (date && time) {
            fetch(`/booking/check-availability/?date=${date}&time=${time}&duration=${duration}&zone=${zone}`)
                .then(response => response.json())
                .then(data => {
                    if (!data.available) {
                        alert('Увага: ' + data.message);
                    }
                });
        }
    }

    dateInput.addEventListener('change', checkAvailability);
    timeInput.addEventListener('change', checkAvailability);
    durationInput.addEventListener('change', checkAvailability);
    zoneSelect.addEventListener('change', checkAvailability);

    // AJAX відправка форми
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        
        fetch('/booking/api/create/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.href = data.redirect_url;
            } else {
                alert('Помилка: ' + data.message);
                if (data.errors) {
                    console.error('Validation errors:', data.errors);
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Сталася помилка при бронюванні');
        });
    });
});
</script>
{% endblock %}